import React, { useState, useEffect, useRef, useMemo } from 'react';
import { 
    Trophy, Plus, Trash2, RotateCcw, Check, X, History, 
    Settings, Play, LogOut, Volume2, Snowflake, Heart 
} from 'lucide-react';

// --- Assets & Config ---
// Ein fröhlicher Sound als Platzhalter. Du kannst hier eine URL zu "Coco Jambo" einfügen, wenn du eine hast.
const WINNER_SOUND_URL = "https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"; 

const styles = `
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
    
    .font-inter { font-family: 'Inter', sans-serif; }
    
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

    .glass-panel {
        background: rgba(30, 41, 59, 0.8);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .anim-pop { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes pop { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    
    .anim-slide-up { animation: slideUp 0.5s ease-out; }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* Custom Checkbox Styles */
    .toggle-checkbox:checked {
        right: 0;
        border-color: #10B981;
    }
    .toggle-checkbox:checked + .toggle-label {
        background-color: #10B981;
    }
`;

// --- Helfer-Funktionen ---
const playWinnerSound = () => {
    const audio = new Audio(WINNER_SOUND_URL);
    audio.volume = 0.5;
    audio.play().catch(e => console.log("Audio play failed (user interaction needed first)", e));
};

// --- Komponenten ---

// Setup Screen
const SetupScreen = ({ onStart }) => {
    const [players, setPlayers] = useState(['Spieler 1', 'Spieler 2']);
    const [newName, setNewName] = useState('');
    const [targetScore, setTargetScore] = useState(501);

    const addPlayer = (e) => {
        e.preventDefault();
        if (newName.trim()) {
            setPlayers([...players, newName.trim()]);
            setNewName('');
        }
    };

    const removePlayer = (index) => {
        setPlayers(players.filter((_, i) => i !== index));
    };

    const testSound = () => {
        playWinnerSound();
    };

    return (
        <div className="min-h-screen flex flex-col items-center justify-center p-4 bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 font-inter text-white">
            <div className="w-full max-w-md glass-panel p-8 rounded-2xl shadow-2xl anim-pop">
                <div className="text-center mb-8 relative">
                    <h1 className="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400 mb-2">Flip 7</h1>
                    <p className="text-slate-400">Tracker & Stats</p>
                    <button 
                        onClick={testSound}
                        className="absolute top-0 right-0 p-2 bg-slate-800 rounded-full hover:bg-slate-700 text-slate-400 hover:text-emerald-400 transition-colors"
                        title="Sound testen"
                    >
                        <Volume2 size={16} />
                    </button>
                </div>

                <div className="space-y-6">
                    <div>
                        <label className="block text-sm font-medium text-slate-300 mb-2">Zielpunktzahl</label>
                        <div className="bg-slate-800 rounded-lg p-1 border border-slate-700">
                            <input 
                                type="number" 
                                value={targetScore} 
                                onChange={(e) => setTargetScore(Number(e.target.value))}
                                className="w-full bg-transparent p-3 text-center font-bold text-xl outline-none text-white placeholder-slate-500"
                            />
                        </div>
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-slate-300 mb-2">Spieler ({players.length})</label>
                        <form onSubmit={addPlayer} className="flex gap-2 mb-4">
                            <input 
                                type="text" 
                                value={newName}
                                onChange={(e) => setNewName(e.target.value)}
                                placeholder="Name eingeben..."
                                className="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 outline-none focus:border-purple-500 transition-colors text-white placeholder-slate-500"
                            />
                            <button type="submit" className="bg-purple-600 hover:bg-purple-500 text-white p-3 rounded-lg transition-colors">
                                <Plus size={24} />
                            </button>
                        </form>

                        <div className="space-y-2 max-h-48 overflow-y-auto pr-2 custom-scroll">
                            {players.map((player, idx) => (
                                <div key={idx} className="flex justify-between items-center bg-slate-800/50 p-3 rounded-lg border border-slate-700/50">
                                    <div className="flex items-center gap-3">
                                        <div className="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-xs font-bold text-white">
                                            {player.charAt(0).toUpperCase()}
                                        </div>
                                        <span className="font-medium text-white">{player}</span>
                                    </div>
                                    <button onClick={() => removePlayer(idx)} className="text-slate-500 hover:text-red-400 transition-colors">
                                        <Trash2 size={18} />
                                    </button>
                                </div>
                            ))}
                        </div>
                    </div>

                    <button 
                        onClick={() => onStart(players, targetScore)}
                        disabled={players.length < 1}
                        className="w-full bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-400 hover:to-teal-400 text-white font-bold py-4 rounded-xl shadow-lg transform transition active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                    >
                        <Play size={20} fill="currentColor" /> Spiel starten
                    </button>
                </div>
            </div>
        </div>
    );
};

// Score Input Modal with Special Cards
const ScoreInput = ({ player, onClose, onSave }) => {
    const [score, setScore] = useState('');
    const [hasFreeze, setHasFreeze] = useState(false);
    const [hasSecondChance, setHasSecondChance] = useState(false);

    const handleNumber = (num) => setScore(prev => prev + num);
    const handleBackspace = () => setScore(prev => prev.slice(0, -1));

    const handleSave = () => {
        const finalScore = score === '' ? 0 : parseInt(score);
        onSave(finalScore, { freeze: hasFreeze, secondChance: hasSecondChance });
    };

    const handleBust = () => {
        onSave(0, { freeze: hasFreeze, secondChance: hasSecondChance });
    };

    return (
        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-in fade-in duration-200 font-inter">
            <div className="w-full max-w-sm glass-panel rounded-2xl overflow-hidden shadow-2xl transform transition-all scale-100">
                <div className="bg-slate-800 p-4 flex justify-between items-center border-b border-slate-700">
                    <h3 className="font-bold text-lg flex items-center gap-2 text-white">
                        <span className="text-purple-400">{player.name}</span>
                        <span className="text-slate-400 text-sm font-normal">Runde {player.history.length + 1}</span>
                    </h3>
                    <button onClick={onClose} className="p-2 hover:bg-slate-700 rounded-full text-slate-400 hover:text-white transition-colors">
                        <X size={20} />
                    </button>
                </div>

                <div className="p-6">
                    {/* Score Display */}
                    <div className="mb-6">
                        <div className="text-5xl font-mono text-center font-bold text-white mb-2 h-16 flex items-center justify-center bg-slate-900 rounded-xl border border-slate-700 shadow-inner">
                            {score || <span className="text-slate-600">0</span>}
                        </div>
                    </div>

                    {/* Special Cards Toggles */}
                    <div className="grid grid-cols-2 gap-3 mb-6">
                        <button 
                            onClick={() => setHasFreeze(!hasFreeze)}
                            className={`p-3 rounded-xl border flex flex-col items-center justify-center gap-1 transition-all ${hasFreeze ? 'bg-cyan-900/40 border-cyan-400 text-cyan-300' : 'bg-slate-800 border-slate-700 text-slate-500'}`}
                        >
                            <Snowflake size={20} />
                            <span className="text-xs font-bold">Freeze</span>
                        </button>
                        <button 
                            onClick={() => setHasSecondChance(!hasSecondChance)}
                            className={`p-3 rounded-xl border flex flex-col items-center justify-center gap-1 transition-all ${hasSecondChance ? 'bg-pink-900/40 border-pink-400 text-pink-300' : 'bg-slate-800 border-slate-700 text-slate-500'}`}
                        >
                            <Heart size={20} />
                            <span className="text-xs font-bold">2nd Chance</span>
                        </button>
                    </div>

                    {/* Numpad */}
                    <div className="grid grid-cols-3 gap-3 mb-4">
                        {[1, 2, 3, 4, 5, 6, 7, 8, 9, 0].map((num) => (
                            <button 
                                key={num} 
                                onClick={() => handleNumber(num.toString())}
                                className={`p-4 rounded-xl text-xl font-bold transition-all active:scale-95 ${num === 0 ? 'col-span-1' : ''} bg-slate-700 hover:bg-slate-600 text-white shadow-md`}
                            >
                                {num}
                            </button>
                        ))}
                        <button 
                            onClick={handleBackspace}
                            className="col-span-2 p-4 rounded-xl bg-slate-700 hover:bg-slate-600 text-red-400 flex items-center justify-center transition-all active:scale-95 shadow-md"
                        >
                            ⌫
                        </button>
                    </div>

                    {/* Actions */}
                    <div className="grid grid-cols-2 gap-3">
                        <button 
                            onClick={handleBust}
                            className="p-4 bg-red-500/20 hover:bg-red-500/30 text-red-400 border border-red-500/50 rounded-xl font-bold flex flex-col items-center justify-center gap-1 transition-all active:scale-95"
                        >
                            <span className="text-xs uppercase tracking-wider">Bust</span>
                            <span>0 Pkt</span>
                        </button>
                        <button 
                            onClick={handleSave}
                            className="p-4 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-bold flex flex-col items-center justify-center gap-1 transition-all active:scale-95 shadow-lg shadow-emerald-900/50"
                        >
                            <span className="text-xs uppercase tracking-wider text-emerald-200">Speichern</span>
                            <Check size={24} />
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
};

// SVG Graph Component
const ScoreGraph = ({ players }) => {
    const height = 200;
    const width = 300;
    const padding = 20;

    // Determine max rounds and score for scaling
    const maxRounds = Math.max(...players.map(p => p.history.length), 1);
    const maxScore = Math.max(...players.map(p => p.score), 100);

    const getX = (roundIndex) => padding + (roundIndex / maxRounds) * (width - 2 * padding);
    const getY = (score) => height - padding - (score / maxScore) * (height - 2 * padding);

    // Colors for lines
    const colors = ["#ef4444", "#3b82f6", "#10b981", "#eab308", "#a855f7", "#ec4899"];

    return (
        <div className="w-full bg-slate-800/50 rounded-xl p-4 mb-6 border border-slate-700">
            <h4 className="text-sm font-bold text-slate-400 mb-4 text-center">Punkteverlauf</h4>
            <div className="relative w-full aspect-[3/2]">
                <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full overflow-visible">
                    {/* Grid Lines */}
                    <line x1={padding} y1={height - padding} x2={width - padding} y2={height - padding} stroke="#475569" strokeWidth="1" />
                    <line x1={padding} y1={padding} x2={padding} y2={height - padding} stroke="#475569" strokeWidth="1" />
                    
                    {/* Player Lines */}
                    {players.map((player, idx) => {
                        let points = ` ${getX(0)},${getY(0)}`; // Start at 0,0
                        player.history.forEach((h, i) => {
                            points += ` ${getX(i + 1)},${getY(h.totalAfter)}`;
                        });

                        return (
                            <g key={player.id}>
                                <polyline 
                                    points={points} 
                                    fill="none" 
                                    stroke={colors[idx % colors.length]} 
                                    strokeWidth="3" 
                                    strokeLinecap="round"
                                    strokeLinejoin="round"
                                    className="drop-shadow-md"
                                />
                                {/* End Dot */}
                                <circle 
                                    cx={getX(player.history.length)} 
                                    cy={getY(player.score)} 
                                    r="4" 
                                    fill={colors[idx % colors.length]} 
                                    stroke="#1e293b"
                                    strokeWidth="2"
                                />
                            </g>
                        );
                    })}
                </svg>
            </div>
            {/* Legend */}
            <div className="flex flex-wrap justify-center gap-3 mt-2">
                {players.map((p, idx) => (
                    <div key={p.id} className="flex items-center gap-1.5">
                        <div className="w-3 h-3 rounded-full" style={{ backgroundColor: colors[idx % colors.length] }}></div>
                        <span className="text-xs text-slate-300">{p.name}</span>
                    </div>
                ))}
            </div>
        </div>
    );
};

// Winner Screen with Stats
const WinnerScreen = ({ winner, players, onReset }) => {
    useEffect(() => {
        playWinnerSound();
    }, []);

    // Calculate Stats
    const getStatWinner = (key) => {
        let maxCount = -1;
        let bestPlayer = null;
        players.forEach(p => {
            const count = p.history.filter(h => h[key]).length;
            if (count > maxCount && count > 0) {
                maxCount = count;
                bestPlayer = p;
            } else if (count === maxCount) {
                bestPlayer = null; // Draw
            }
        });
        return { player: bestPlayer, count: maxCount };
    };

    const lucky = getStatWinner('secondChance'); // Glückspilz
    const icy = getStatWinner('freeze'); // Eisblock

    return (
        <div className="fixed inset-0 z-[60] flex flex-col items-center justify-center bg-black/95 backdrop-blur-md p-4 anim-pop font-inter overflow-y-auto">
            <div className="w-full max-w-lg my-auto">
                <div className="text-center mb-8">
                    <div className="inline-block p-6 rounded-full bg-gradient-to-br from-yellow-400 to-orange-500 shadow-2xl shadow-orange-500/50 mb-6 animate-bounce">
                        <Trophy size={64} className="text-white" />
                    </div>
                    <h2 className="text-5xl font-extrabold text-white mb-2 tracking-tight">Gewonnen!</h2>
                    <p className="text-2xl text-slate-300 mb-2">{winner.name} hat das Ziel erreicht.</p>
                    <div className="text-6xl font-mono font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-orange-400">
                        {winner.score} Pkt
                    </div>
                </div>

                {/* Awards */}
                <div className="grid grid-cols-2 gap-4 mb-8">
                    {lucky.player && (
                        <div className="bg-slate-800/50 p-4 rounded-xl border border-pink-500/30 text-center anim-slide-up">
                            <Heart className="mx-auto text-pink-400 mb-2" size={24} />
                            <div className="text-sm text-slate-400 uppercase font-bold">Glückspilz</div>
                            <div className="text-lg font-bold text-white">{lucky.player.name}</div>
                            <div className="text-xs text-slate-500">{lucky.count}x 2nd Chance</div>
                        </div>
                    )}
                    {icy.player && (
                        <div className="bg-slate-800/50 p-4 rounded-xl border border-cyan-500/30 text-center anim-slide-up" style={{animationDelay: '0.1s'}}>
                            <Snowflake className="mx-auto text-cyan-400 mb-2" size={24} />
                            <div className="text-sm text-slate-400 uppercase font-bold">Coolster Kopf</div>
                            <div className="text-lg font-bold text-white">{icy.player.name}</div>
                            <div className="text-xs text-slate-500">{icy.count}x Freeze</div>
                        </div>
                    )}
                </div>

                {/* Graph */}
                <ScoreGraph players={players} />

                <button 
                    onClick={onReset}
                    className="w-full bg-white text-slate-900 hover:bg-slate-200 font-bold py-4 px-8 rounded-xl shadow-lg transition-transform hover:scale-[1.02] flex items-center justify-center gap-2"
                >
                    <RotateCcw size={20} /> Neues Spiel
                </button>
            </div>
        </div>
    );
};

// Main Game Screen
const GameScreen = ({ players, targetScore, onUpdateScore, onEndGame }) => {
    const [selectedPlayer, setSelectedPlayer] = useState(null);
    const [viewHistoryPlayer, setViewHistoryPlayer] = useState(null);
    const [showQuitConfirm, setShowQuitConfirm] = useState(false);

    // Calculate current round (minimum rounds played by any player)
    const minRoundsPlayed = Math.min(...players.map(p => p.history.length));

    // Sort players by score
    const sortedPlayers = [...players].sort((a, b) => b.score - a.score);
    const leaderId = (sortedPlayers.length > 0 && sortedPlayers[0].score > 0) ? sortedPlayers[0].id : null;

    const handleScoreSave = (points, specials) => {
        if (selectedPlayer) {
            onUpdateScore(selectedPlayer.id, points, specials);
            setSelectedPlayer(null);
        }
    };

    return (
        <div className="min-h-screen bg-slate-900 pb-20 font-inter text-white">
            {/* Header */}
            <div className="sticky top-0 z-30 bg-slate-900/90 backdrop-blur-md border-b border-white/10 px-4 py-4 shadow-lg">
                <div className="max-w-3xl mx-auto flex justify-between items-center">
                    <div className="flex flex-col">
                        <span className="text-xs text-slate-400 uppercase tracking-widest font-bold">Ziel</span>
                        <span className="text-xl font-bold text-emerald-400">{targetScore}</span>
                    </div>
                    <div>
                        <h1 className="text-lg font-bold text-white tracking-wide text-center">Flip 7</h1>
                        <div className="text-xs text-slate-500 text-center font-mono">Runde {minRoundsPlayed + 1}</div>
                    </div>
                    <button 
                        onClick={() => setShowQuitConfirm(true)} 
                        className="p-2 bg-slate-800 rounded-lg text-slate-400 hover:text-white transition-colors"
                    >
                        <Settings size={20} />
                    </button>
                </div>
            </div>

            {/* Players Grid */}
            <div className="max-w-3xl mx-auto p-4 grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
                {players.map(player => {
                    const isLeader = player.id === leaderId;
                    const progress = Math.min((player.score / targetScore) * 100, 100);
                    const lastEntry = player.history.length > 0 ? player.history[player.history.length - 1] : null;
                    const lastRoundPoints = lastEntry ? lastEntry.points : null;
                    
                    // Logic to gray out: If player is ahead of the minimum rounds, they wait.
                    const isWaiting = player.history.length > minRoundsPlayed;

                    return (
                        <div 
                            key={player.id} 
                            className={`relative glass-panel rounded-xl overflow-hidden transition-all duration-300 
                                ${isLeader ? 'border-yellow-500/50 shadow-yellow-900/20 shadow-lg scale-[1.02] z-10' : ''}
                                ${isWaiting ? 'opacity-60 grayscale-[0.5]' : 'hover:bg-slate-800/80'}
                            `}
                        >
                            {/* Progress Bar */}
                            <div 
                                className="absolute bottom-0 left-0 h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 transition-all duration-1000 ease-out"
                                style={{ width: `${progress}%` }}
                            ></div>

                            <div className="p-4 flex flex-col h-full">
                                <div className="flex justify-between items-start mb-4">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg shadow-inner ${isLeader ? 'bg-gradient-to-br from-yellow-400 to-orange-500 text-white ring-2 ring-yellow-500/30' : 'bg-slate-700 text-slate-300'}`}>
                                            {isLeader ? <Trophy size={18} /> : player.name.charAt(0)}
                                        </div>
                                        <div>
                                            <h3 className="font-bold text-white text-lg leading-tight flex items-center gap-2">
                                                {player.name}
                                                {isWaiting && <Check size={14} className="text-emerald-400" />}
                                            </h3>
                                            <div className="flex items-center gap-2 mt-1">
                                                <span className="text-xs text-slate-400">Letzte:</span>
                                                <span className={`text-xs font-mono font-bold px-1.5 py-0.5 rounded ${lastRoundPoints === 0 ? 'bg-red-500/20 text-red-400' : lastRoundPoints > 0 ? 'bg-emerald-500/20 text-emerald-400' : 'text-slate-500'}`}>
                                                    {lastRoundPoints !== null ? (lastRoundPoints === 0 ? 'BUST' : `+${lastRoundPoints}`) : '-'}
                                                </span>
                                                {/* Indicators for special cards in last round */}
                                                {lastEntry?.freeze && <Snowflake size={12} className="text-cyan-400" />}
                                                {lastEntry?.secondChance && <Heart size={12} className="text-pink-400" />}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-3xl font-mono font-bold text-white tracking-tighter">
                                            {player.score}
                                        </div>
                                        <div className="text-xs text-slate-500 font-medium text-right">Punkte</div>
                                    </div>
                                </div>

                                <div className="mt-auto grid grid-cols-4 gap-2">
                                    <button 
                                        onClick={() => setViewHistoryPlayer(player)}
                                        className="col-span-1 bg-slate-700/50 hover:bg-slate-700 text-slate-400 rounded-lg py-3 flex items-center justify-center transition-colors"
                                    >
                                        <History size={18} />
                                    </button>
                                    <button 
                                        onClick={() => setSelectedPlayer(player)}
                                        disabled={isWaiting}
                                        className={`col-span-3 font-bold py-3 rounded-lg shadow-lg flex items-center justify-center gap-2 transition-all active:scale-95
                                            ${isWaiting 
                                                ? 'bg-slate-700 text-slate-500 cursor-not-allowed shadow-none' 
                                                : 'bg-blue-600 hover:bg-blue-500 text-white shadow-blue-900/20'}
                                        `}
                                    >
                                        {isWaiting ? <Check size={18} /> : <><Plus size={18} /> Punkte</>}
                                    </button>
                                </div>
                            </div>
                        </div>
                    );
                })}
            </div>

            {selectedPlayer && (
                <ScoreInput 
                    player={selectedPlayer} 
                    onClose={() => setSelectedPlayer(null)} 
                    onSave={handleScoreSave}
                />
            )}

            {viewHistoryPlayer && (
                // Reusing previous HistoryModal code (simplified here for brevity as it's largely display)
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 font-inter">
                    <div className="w-full max-w-sm glass-panel rounded-2xl overflow-hidden shadow-2xl max-h-[80vh] flex flex-col">
                        <div className="bg-slate-800 p-4 flex justify-between items-center border-b border-slate-700">
                            <h3 className="font-bold text-lg text-white">Verlauf: {viewHistoryPlayer.name}</h3>
                            <button onClick={() => setViewHistoryPlayer(null)} className="p-2 hover:bg-slate-700 rounded-full text-slate-400">
                                <X size={20} />
                            </button>
                        </div>
                        <div className="p-4 overflow-y-auto flex-1">
                             <table className="w-full text-left border-collapse">
                                <thead>
                                    <tr className="text-slate-400 text-sm border-b border-slate-700">
                                        <th className="py-2 px-2">#</th>
                                        <th className="py-2 px-2 text-right">Punkte</th>
                                        <th className="py-2 px-2 text-center">Infos</th>
                                        <th className="py-2 px-2 text-right">Σ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {viewHistoryPlayer.history.map((entry, idx) => (
                                        <tr key={idx} className="border-b border-slate-700/50 last:border-0 hover:bg-white/5">
                                            <td className="py-3 px-2 text-slate-300">{idx + 1}</td>
                                            <td className={`py-3 px-2 text-right font-mono ${entry.points === 0 ? 'text-red-400' : 'text-emerald-400'}`}>
                                                {entry.points > 0 ? '+' : ''}{entry.points}
                                            </td>
                                            <td className="py-3 px-2 text-center flex justify-center gap-1">
                                                {entry.freeze && <Snowflake size={14} className="text-cyan-400" />}
                                                {entry.secondChance && <Heart size={14} className="text-pink-400" />}
                                            </td>
                                            <td className="py-3 px-2 text-right font-bold text-white">
                                                {entry.totalAfter}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            )}

            {showQuitConfirm && (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 font-inter">
                    <div className="bg-slate-800 p-6 rounded-2xl shadow-2xl max-w-sm w-full border border-slate-700 anim-pop">
                        <h3 className="text-xl font-bold text-white mb-2 flex items-center gap-2">
                            <LogOut className="text-red-400" size={24} />
                            Spiel beenden?
                        </h3>
                        <div className="flex justify-between items-center mb-6 p-3 bg-slate-900 rounded-lg">
                            <span className="text-slate-400 text-sm">Winner Sound Test:</span>
                            <button onClick={() => playWinnerSound()} className="p-2 bg-slate-800 hover:bg-slate-700 rounded-full text-emerald-400">
                                <Volume2 size={16} />
                            </button>
                        </div>
                        <div className="flex justify-end gap-3">
                            <button onClick={() => setShowQuitConfirm(false)} className="px-4 py-2 text-slate-300 hover:bg-slate-700 rounded-lg">Abbrechen</button>
                            <button onClick={onEndGame} className="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg font-bold shadow-lg shadow-red-900/30">Beenden</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

// Main App Container
export default function App() {
    const [appState, setAppState] = useState('setup');
    const [players, setPlayers] = useState([]);
    const [targetScore, setTargetScore] = useState(501);
    const [winner, setWinner] = useState(null);

    const startGame = (playerNames, target) => {
        const initialPlayers = playerNames.map((name, idx) => ({
            id: idx,
            name: name,
            score: 0,
            history: [] // Array of { points, totalAfter, freeze, secondChance }
        }));
        setPlayers(initialPlayers);
        setTargetScore(target);
        setAppState('playing');
    };

    const updateScore = (playerId, points, specials = { freeze: false, secondChance: false }) => {
        const updatedPlayers = players.map(p => {
            if (p.id === playerId) {
                const newScore = p.score + points;
                const newHistory = [...p.history, { 
                    points, 
                    totalAfter: newScore,
                    freeze: specials.freeze,
                    secondChance: specials.secondChance
                }];
                return { ...p, score: newScore, history: newHistory };
            }
            return p;
        });
        setPlayers(updatedPlayers);

        // Check winner
        const player = updatedPlayers.find(p => p.id === playerId);
        if (player.score >= targetScore) {
            setWinner(player);
            setAppState('finished');
        }
    };

    const resetGame = () => {
        setAppState('setup');
        setWinner(null);
        setPlayers([]);
    };

    return (
        <>
            <style>{styles}</style>
            {appState === 'setup' && <SetupScreen onStart={startGame} />}
            {appState === 'playing' && (
                <GameScreen 
                    players={players} 
                    targetScore={targetScore} 
                    onUpdateScore={updateScore}
                    onEndGame={resetGame}
                />
            )}
            {appState === 'finished' && (
                <WinnerScreen winner={winner} players={players} onReset={resetGame} />
            )}
        </>
    );
};
