<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flip 7 Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(150, 150, 150, 0.3); border-radius: 3px; }

        .anim-pop { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        .anim-slide-up { animation: slideUp 0.5s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Smooth Transition for Theme Changes */
        .theme-transition { transition: background-color 0.5s ease, color 0.5s ease, border-color 0.5s ease; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, createContext, useContext } = React;

        // --- Theme Definitionen ---
        const themes = {
            midnight: {
                id: 'midnight',
                name: 'Midnight',
                colors: {
                    bg: 'bg-slate-900',
                    bgGradient: 'bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900',
                    text: 'text-white',
                    textMuted: 'text-slate-400',
                    panel: 'bg-slate-800/80 backdrop-blur-md border border-white/10',
                    input: 'bg-slate-900 border-slate-700 text-white placeholder-slate-500',
                    button: 'bg-slate-700 hover:bg-slate-600 text-white',
                    buttonPrimary: 'bg-blue-600 hover:bg-blue-500 text-white shadow-blue-900/20',
                    accent: 'text-emerald-400',
                    cardLeader: 'border-yellow-500/50 shadow-yellow-900/20',
                    modalOverlay: 'bg-black/80',
                }
            },
            cloud: {
                id: 'cloud',
                name: 'Cloud',
                colors: {
                    bg: 'bg-slate-50',
                    bgGradient: 'bg-gradient-to-br from-slate-100 via-blue-100 to-white',
                    text: 'text-slate-800',
                    textMuted: 'text-slate-500',
                    panel: 'bg-white/90 backdrop-blur-md border border-slate-200 shadow-xl',
                    input: 'bg-white border-slate-300 text-slate-800 placeholder-slate-400',
                    button: 'bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 shadow-sm',
                    buttonPrimary: 'bg-blue-600 hover:bg-blue-700 text-white shadow-blue-200',
                    accent: 'text-blue-600',
                    cardLeader: 'border-yellow-400 shadow-yellow-200',
                    modalOverlay: 'bg-slate-900/40',
                }
            },
            forest: {
                id: 'forest',
                name: 'Forest',
                colors: {
                    bg: 'bg-stone-900',
                    bgGradient: 'bg-gradient-to-br from-stone-900 via-emerald-950 to-stone-900',
                    text: 'text-stone-100',
                    textMuted: 'text-stone-400',
                    panel: 'bg-stone-800/80 backdrop-blur-md border border-stone-600',
                    input: 'bg-stone-950 border-stone-700 text-stone-100 placeholder-stone-600',
                    button: 'bg-stone-700 hover:bg-stone-600 text-stone-100',
                    buttonPrimary: 'bg-emerald-700 hover:bg-emerald-600 text-white shadow-emerald-900/30',
                    accent: 'text-amber-400',
                    cardLeader: 'border-amber-500/50 shadow-amber-900/20',
                    modalOverlay: 'bg-black/80',
                }
            },
            neon: {
                id: 'neon',
                name: 'Neon',
                colors: {
                    bg: 'bg-black',
                    bgGradient: 'bg-gradient-to-br from-black via-fuchsia-950 to-black',
                    text: 'text-fuchsia-50',
                    textMuted: 'text-fuchsia-400/60',
                    panel: 'bg-black/60 backdrop-blur-md border border-fuchsia-500/30',
                    input: 'bg-black border-fuchsia-900 text-fuchsia-100 placeholder-fuchsia-900',
                    button: 'bg-fuchsia-950/50 border border-fuchsia-900/50 hover:bg-fuchsia-900/50 text-fuchsia-100',
                    buttonPrimary: 'bg-fuchsia-600 hover:bg-fuchsia-500 text-white shadow-[0_0_15px_rgba(192,38,211,0.5)]',
                    accent: 'text-cyan-400',
                    cardLeader: 'border-cyan-400 shadow-[0_0_15px_rgba(34,211,238,0.3)]',
                    modalOverlay: 'bg-black/90',
                }
            }
        };

        const ThemeContext = createContext(null);

        // --- Icons ---
        const LucideIcon = ({ name, size = 24, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && window.lucide?.icons?.[name]) {
                    const iconElement = window.lucide.createElement(window.lucide.icons[name]);
                    iconElement.setAttribute('width', size);
                    iconElement.setAttribute('height', size);
                    iconElement.setAttribute('class', className);
                    ref.current.innerHTML = '';
                    ref.current.appendChild(iconElement);
                }
            }, [name, size, className]);
            return <span ref={ref} className="inline-flex items-center justify-center" style={{ width: size, height: size }} />;
        };

        const Icon = (props) => <LucideIcon {...props} />;

        // --- Config ---
        const WINNER_SOUND_URL = "https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"; 

        const playWinnerSound = () => {
            const audio = new Audio(WINNER_SOUND_URL);
            audio.volume = 0.5;
            audio.play().catch(e => console.log("Audio play failed", e));
        };

        // --- Components ---

        // Settings Modal with Theme Switcher
        const SettingsModal = ({ onClose, onQuit, currentThemeId, onSetTheme }) => {
            const theme = themes[currentThemeId].colors;

            return (
                <div className={`fixed inset-0 z-50 flex items-center justify-center ${theme.modalOverlay} backdrop-blur-sm p-4 font-inter`}>
                    <div className={`${theme.panel} p-6 rounded-2xl shadow-2xl max-w-sm w-full anim-pop overflow-hidden`}>
                        <div className="flex justify-between items-center mb-6">
                            <h3 className={`text-xl font-bold ${theme.text} flex items-center gap-2`}>
                                <Icon name="Settings" size={24} /> Einstellungen
                            </h3>
                            <button onClick={onClose} className={`p-2 rounded-full hover:opacity-80 transition-opacity ${theme.textMuted}`}>
                                <Icon name="X" size={20} />
                            </button>
                        </div>

                        {/* Theme Switcher */}
                        <div className="mb-8">
                            <h4 className={`text-sm font-bold uppercase tracking-wider ${theme.textMuted} mb-3`}>Design</h4>
                            <div className="grid grid-cols-2 gap-3">
                                {Object.values(themes).map((t) => (
                                    <button
                                        key={t.id}
                                        onClick={() => onSetTheme(t.id)}
                                        className={`relative p-3 rounded-xl border-2 transition-all flex items-center gap-3 overflow-hidden
                                            ${currentThemeId === t.id ? 'border-blue-500 ring-2 ring-blue-500/20' : 'border-transparent hover:border-gray-500/30'}
                                            ${t.id === 'cloud' ? 'bg-slate-100' : 'bg-slate-800'}
                                        `}
                                    >
                                        {/* Preview Circle */}
                                        <div className={`w-8 h-8 rounded-full shadow-inner flex-shrink-0 bg-gradient-to-br 
                                            ${t.id === 'midnight' ? 'from-slate-900 to-purple-900' : ''}
                                            ${t.id === 'cloud' ? 'from-white to-blue-100 border border-slate-300' : ''}
                                            ${t.id === 'forest' ? 'from-stone-900 to-emerald-900' : ''}
                                            ${t.id === 'neon' ? 'from-black to-fuchsia-900 border border-fuchsia-500/50' : ''}
                                        `}></div>
                                        <span className={`font-medium text-sm ${t.id === 'cloud' ? 'text-slate-800' : 'text-white'}`}>
                                            {t.name}
                                        </span>
                                        {currentThemeId === t.id && (
                                            <div className="absolute top-2 right-2 text-blue-500">
                                                <Icon name="Check" size={14} />
                                            </div>
                                        )}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Sound Test */}
                        <div className={`flex justify-between items-center mb-6 p-3 rounded-lg ${theme.input}`}>
                            <span className={`text-sm ${theme.textMuted}`}>Sound-Check</span>
                            <button onClick={() => playWinnerSound()} className={`p-2 rounded-full ${theme.button} hover:opacity-80`}>
                                <Icon name="Volume2" size={18} />
                            </button>
                        </div>

                        {/* Quit Button */}
                        <button 
                            onClick={onQuit} 
                            className="w-full px-4 py-3 bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/20 rounded-xl font-bold transition-colors flex items-center justify-center gap-2"
                        >
                            <Icon name="LogOut" size={18} /> Spiel beenden
                        </button>
                    </div>
                </div>
            );
        };

        const SetupScreen = ({ onStart }) => {
            const { theme } = useContext(ThemeContext);
            const [players, setPlayers] = useState(['Spieler 1', 'Spieler 2']);
            const [newName, setNewName] = useState('');
            const [targetScore, setTargetScore] = useState('501'); // String statt Number für leeres Feld

            const addPlayer = (e) => {
                e.preventDefault();
                if (newName.trim()) {
                    setPlayers([...players, newName.trim()]);
                    setNewName('');
                }
            };

            const removePlayer = (index) => {
                setPlayers(players.filter((_, i) => i !== index));
            };

            return (
                <div className={`min-h-screen flex flex-col items-center justify-center p-4 ${theme.bgGradient} theme-transition font-inter ${theme.text}`}>
                    <div className={`w-full max-w-md ${theme.panel} p-8 rounded-2xl shadow-2xl anim-pop`}>
                        <div className="text-center mb-8 relative">
                            <h1 className="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400 mb-2">Flip 7</h1>
                            <p className={theme.textMuted}>Tracker & Stats</p>
                        </div>

                        <div className="space-y-6">
                            <div>
                                <label className={`block text-sm font-medium ${theme.textMuted} mb-2`}>Zielpunktzahl</label>
                                <div className={`rounded-lg p-1 ${theme.input}`}>
                                    <input 
                                        type="number" 
                                        value={targetScore} 
                                        onChange={(e) => setTargetScore(e.target.value)}
                                        className={`w-full bg-transparent p-3 text-center font-bold text-xl outline-none ${theme.text}`}
                                    />
                                </div>
                            </div>

                            <div>
                                <label className={`block text-sm font-medium ${theme.textMuted} mb-2`}>Spieler ({players.length})</label>
                                <form onSubmit={addPlayer} className="flex gap-2 mb-4">
                                    <input 
                                        type="text" 
                                        value={newName}
                                        onChange={(e) => setNewName(e.target.value)}
                                        placeholder="Name eingeben..."
                                        className={`flex-1 ${theme.input} rounded-lg px-4 py-3 outline-none focus:ring-1 focus:ring-purple-500 transition-colors`}
                                    />
                                    <button type="submit" className={`p-3 rounded-lg transition-colors ${theme.buttonPrimary}`}>
                                        <Icon name="Plus" size={24} />
                                    </button>
                                </form>

                                <div className="space-y-2 max-h-48 overflow-y-auto pr-2 custom-scroll">
                                    {players.map((player, idx) => (
                                        <div key={idx} className={`flex justify-between items-center p-3 rounded-lg ${theme.input.replace('bg-', 'bg-opacity-50 ')}`}>
                                            <div className="flex items-center gap-3">
                                                <div className="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-xs font-bold text-white">
                                                    {player.charAt(0).toUpperCase()}
                                                </div>
                                                <span className="font-medium">{player}</span>
                                            </div>
                                            <button onClick={() => removePlayer(idx)} className={`${theme.textMuted} hover:text-red-400 transition-colors`}>
                                                <Icon name="Trash2" size={18} />
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <button 
                                onClick={() => onStart(players, parseInt(targetScore) || 501)}
                                disabled={players.length < 1}
                                className={`w-full font-bold py-4 rounded-xl shadow-lg transform transition active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 ${theme.buttonPrimary}`}
                            >
                                <Icon name="Play" size={20} fill="currentColor" /> Spiel starten
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const ScoreInput = ({ player, onClose, onSave }) => {
            const { theme } = useContext(ThemeContext);
            const [score, setScore] = useState(''); // Start empty
            const [hasFreeze, setHasFreeze] = useState(false);
            const [hasSecondChance, setHasSecondChance] = useState(false);

            // Optimierte Nummerneingabe
            const handleNumber = (num) => {
                setScore(prev => {
                    // Wenn vorher "0" war oder leer, ersetze es durch die neue Zahl (verhindert "0100")
                    if (prev === '0' || prev === '') return num;
                    return prev + num;
                });
            };

            const handleBackspace = () => setScore(prev => prev.slice(0, -1));

            const handleSave = () => {
                const finalScore = score === '' ? 0 : parseInt(score);
                onSave(finalScore, { freeze: hasFreeze, secondChance: hasSecondChance });
            };

            const handleBust = () => {
                onSave(0, { freeze: hasFreeze, secondChance: hasSecondChance });
            };

            return (
                <div className={`fixed inset-0 z-50 flex items-end sm:items-center justify-center ${theme.modalOverlay} backdrop-blur-sm p-4 animate-in fade-in duration-200 font-inter`}>
                    <div className={`w-full max-w-sm ${theme.panel} rounded-2xl overflow-hidden shadow-2xl transform transition-all scale-100`}>
                        <div className={`p-4 flex justify-between items-center border-b ${theme.colors?.input ? theme.colors.input.split(' ')[1] : 'border-white/10'}`}>
                            <h3 className={`font-bold text-lg flex items-center gap-2 ${theme.text}`}>
                                <span className={theme.accent?.replace('text-', 'text-opacity-80 ')}>{player.name}</span>
                                <span className={`${theme.textMuted} text-sm font-normal`}>Runde {player.history.length + 1}</span>
                            </h3>
                            <button onClick={onClose} className={`p-2 rounded-full ${theme.textMuted} hover:text-white transition-colors`}>
                                <Icon name="X" size={20} />
                            </button>
                        </div>

                        <div className="p-6">
                            <div className="mb-6">
                                <div className={`text-5xl font-mono text-center font-bold ${theme.text} mb-2 h-16 flex items-center justify-center rounded-xl shadow-inner ${theme.input}`}>
                                    {score || <span className="opacity-30">0</span>}
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-3 mb-6">
                                <button 
                                    onClick={() => setHasFreeze(!hasFreeze)}
                                    className={`p-3 rounded-xl border flex flex-col items-center justify-center gap-1 transition-all ${hasFreeze ? 'bg-cyan-500/20 border-cyan-400 text-cyan-400' : `${theme.button} border-transparent opacity-70`}`}
                                >
                                    <Icon name="Snowflake" size={20} />
                                    <span className="text-xs font-bold">Freeze</span>
                                </button>
                                <button 
                                    onClick={() => setHasSecondChance(!hasSecondChance)}
                                    className={`p-3 rounded-xl border flex flex-col items-center justify-center gap-1 transition-all ${hasSecondChance ? 'bg-pink-500/20 border-pink-400 text-pink-400' : `${theme.button} border-transparent opacity-70`}`}
                                >
                                    <Icon name="Heart" size={20} />
                                    <span className="text-xs font-bold">2nd Chance</span>
                                </button>
                            </div>

                            <div className="grid grid-cols-3 gap-3 mb-4">
                                {[1, 2, 3, 4, 5, 6, 7, 8, 9, 0].map((num) => (
                                    <button 
                                        key={num} 
                                        onClick={() => handleNumber(num.toString())}
                                        className={`p-4 rounded-xl text-xl font-bold transition-all active:scale-95 ${num === 0 ? 'col-span-1' : ''} ${theme.button} shadow-md`}
                                    >
                                        {num}
                                    </button>
                                ))}
                                <button 
                                    onClick={handleBackspace}
                                    className={`col-span-2 p-4 rounded-xl text-red-400 flex items-center justify-center transition-all active:scale-95 shadow-md ${theme.button}`}
                                >
                                    ⌫
                                </button>
                            </div>

                            <div className="grid grid-cols-2 gap-3">
                                <button 
                                    onClick={handleBust}
                                    className="p-4 bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/30 rounded-xl font-bold flex flex-col items-center justify-center gap-1 transition-all active:scale-95"
                                >
                                    <span className="text-xs uppercase tracking-wider">Bust</span>
                                    <span>0 Pkt</span>
                                </button>
                                <button 
                                    onClick={handleSave}
                                    className="p-4 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-bold flex flex-col items-center justify-center gap-1 transition-all active:scale-95 shadow-lg shadow-emerald-900/30"
                                >
                                    <span className="text-xs uppercase tracking-wider text-emerald-100">Speichern</span>
                                    <Icon name="Check" size={24} />
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ScoreGraph = ({ players }) => {
            const { theme } = useContext(ThemeContext);
            const height = 200;
            const width = 300;
            const padding = 20;

            const maxRounds = Math.max(...players.map(p => p.history.length), 1);
            const maxScore = Math.max(...players.map(p => p.score), 100);

            const getX = (roundIndex) => padding + (roundIndex / maxRounds) * (width - 2 * padding);
            const getY = (score) => height - padding - (score / maxScore) * (height - 2 * padding);

            const colors = ["#ef4444", "#3b82f6", "#10b981", "#eab308", "#a855f7", "#ec4899"];

            return (
                <div className={`w-full rounded-xl p-4 mb-6 ${theme.input.replace('bg-', 'bg-opacity-30 ')}`}>
                    <h4 className={`text-sm font-bold ${theme.textMuted} mb-4 text-center`}>Punkteverlauf</h4>
                    <div className="relative w-full aspect-[3/2]">
                        <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full overflow-visible">
                            <line x1={padding} y1={height - padding} x2={width - padding} y2={height - padding} stroke="currentColor" strokeOpacity="0.2" strokeWidth="1" className={theme.text} />
                            <line x1={padding} y1={padding} x2={padding} y2={height - padding} stroke="currentColor" strokeOpacity="0.2" strokeWidth="1" className={theme.text} />
                            
                            {players.map((player, idx) => {
                                let points = ` ${getX(0)},${getY(0)}`;
                                player.history.forEach((h, i) => {
                                    points += ` ${getX(i + 1)},${getY(h.totalAfter)}`;
                                });

                                return (
                                    <g key={player.id}>
                                        <polyline 
                                            points={points} 
                                            fill="none" 
                                            stroke={colors[idx % colors.length]} 
                                            strokeWidth="3" 
                                            strokeLinecap="round"
                                            strokeLinejoin="round"
                                            className="drop-shadow-md"
                                        />
                                        <circle 
                                            cx={getX(player.history.length)} 
                                            cy={getY(player.score)} 
                                            r="4" 
                                            fill={colors[idx % colors.length]} 
                                            stroke="currentColor"
                                            strokeWidth="2"
                                            className={theme.text}
                                        />
                                    </g>
                                );
                            })}
                        </svg>
                    </div>
                </div>
            );
        };

        const WinnerScreen = ({ winner, players, onReset }) => {
            const { theme } = useContext(ThemeContext);
            useEffect(() => { playWinnerSound(); }, []);

            const getStatWinner = (key) => {
                let maxCount = -1;
                let bestPlayer = null;
                players.forEach(p => {
                    const count = p.history.filter(h => h[key]).length;
                    if (count > maxCount && count > 0) { maxCount = count; bestPlayer = p; } 
                    else if (count === maxCount) { bestPlayer = null; }
                });
                return { player: bestPlayer, count: maxCount };
            };

            const lucky = getStatWinner('secondChance');
            const icy = getStatWinner('freeze');

            return (
                <div className={`fixed inset-0 z-[60] flex flex-col items-center justify-center ${theme.modalOverlay} backdrop-blur-md p-4 anim-pop font-inter overflow-y-auto`}>
                    <div className="w-full max-w-lg my-auto">
                        <div className="text-center mb-8">
                            <div className="inline-block p-6 rounded-full bg-gradient-to-br from-yellow-400 to-orange-500 shadow-2xl shadow-orange-500/50 mb-6 animate-bounce">
                                <Icon name="Trophy" size={64} className="text-white" />
                            </div>
                            <h2 className="text-5xl font-extrabold text-white mb-2 tracking-tight">Gewonnen!</h2>
                            <p className="text-2xl text-white/80 mb-2">{winner.name} hat das Ziel erreicht.</p>
                            <div className="text-6xl font-mono font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-orange-400">
                                {winner.score} Pkt
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4 mb-8">
                            {lucky.player && (
                                <div className={`p-4 rounded-xl border border-pink-500/30 text-center anim-slide-up ${theme.panel}`}>
                                    <Icon name="Heart" className="mx-auto text-pink-400 mb-2" size={24} />
                                    <div className={`text-sm uppercase font-bold ${theme.textMuted}`}>Glückspilz</div>
                                    <div className={`text-lg font-bold ${theme.text}`}>{lucky.player.name}</div>
                                    <div className={`text-xs ${theme.textMuted}`}>{lucky.count}x 2nd Chance</div>
                                </div>
                            )}
                            {icy.player && (
                                <div className={`p-4 rounded-xl border border-cyan-500/30 text-center anim-slide-up ${theme.panel}`} style={{animationDelay: '0.1s'}}>
                                    <Icon name="Snowflake" className="mx-auto text-cyan-400 mb-2" size={24} />
                                    <div className={`text-sm uppercase font-bold ${theme.textMuted}`}>Coolster Kopf</div>
                                    <div className={`text-lg font-bold ${theme.text}`}>{icy.player.name}</div>
                                    <div className={`text-xs ${theme.textMuted}`}>{icy.count}x Freeze</div>
                                </div>
                            )}
                        </div>

                        <ScoreGraph players={players} />

                        <button 
                            onClick={onReset}
                            className={`w-full font-bold py-4 px-8 rounded-xl shadow-lg transition-transform hover:scale-[1.02] flex items-center justify-center gap-2 bg-white text-slate-900 hover:bg-slate-200`}
                        >
                            <Icon name="RotateCcw" size={20} /> Neues Spiel
                        </button>
                    </div>
                </div>
            );
        };

        const GameScreen = ({ players, targetScore, onUpdateScore, onEndGame }) => {
            const { theme } = useContext(ThemeContext);
            const [selectedPlayer, setSelectedPlayer] = useState(null);
            const [viewHistoryPlayer, setViewHistoryPlayer] = useState(null);
            const [showSettings, setShowSettings] = useState(false);

            // Context for Settings Modal
            const { currentThemeId, setThemeId } = useContext(ThemeContext);

            const minRoundsPlayed = Math.min(...players.map(p => p.history.length));
            const sortedPlayers = [...players].sort((a, b) => b.score - a.score);
            const leaderId = (sortedPlayers.length > 0 && sortedPlayers[0].score > 0) ? sortedPlayers[0].id : null;

            const handleScoreSave = (points, specials) => {
                if (selectedPlayer) {
                    onUpdateScore(selectedPlayer.id, points, specials);
                    setSelectedPlayer(null);
                }
            };

            return (
                <div className={`min-h-screen pb-20 font-inter ${theme.bg} ${theme.bgGradient || ''} theme-transition ${theme.text}`}>
                    <div className={`sticky top-0 z-30 backdrop-blur-md border-b px-4 py-4 shadow-lg ${theme.panel.split(' ')[0]} ${theme.colors?.input ? theme.colors.input.split(' ')[1] : 'border-white/10'}`}>
                        <div className="max-w-3xl mx-auto flex justify-between items-center">
                            <div className="flex flex-col">
                                <span className={`text-xs uppercase tracking-widest font-bold ${theme.textMuted}`}>Ziel</span>
                                <span className={`text-xl font-bold ${theme.accent}`}>{targetScore}</span>
                            </div>
                            <div>
                                <h1 className={`text-lg font-bold tracking-wide text-center ${theme.text}`}>Flip 7</h1>
                                <div className={`text-xs text-center font-mono ${theme.textMuted}`}>Runde {minRoundsPlayed + 1}</div>
                            </div>
                            <button 
                                onClick={() => setShowSettings(true)} 
                                className={`p-2 rounded-lg transition-colors ${theme.button} bg-opacity-50`}
                            >
                                <Icon name="Settings" size={20} />
                            </button>
                        </div>
                    </div>

                    <div className="max-w-3xl mx-auto p-4 grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
                        {players.map(player => {
                            const isLeader = player.id === leaderId;
                            const progress = Math.min((player.score / targetScore) * 100, 100);
                            const lastEntry = player.history.length > 0 ? player.history[player.history.length - 1] : null;
                            const lastRoundPoints = lastEntry ? lastEntry.points : null;
                            const isWaiting = player.history.length > minRoundsPlayed;

                            return (
                                <div 
                                    key={player.id} 
                                    className={`relative ${theme.panel} rounded-xl overflow-hidden transition-all duration-300 
                                        ${isLeader ? `${theme.cardLeader} shadow-lg scale-[1.02] z-10 border-2` : ''}
                                        ${isWaiting ? 'opacity-60 grayscale-[0.5]' : 'hover:brightness-110'}
                                    `}
                                >
                                    <div 
                                        className="absolute bottom-0 left-0 h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 transition-all duration-1000 ease-out"
                                        style={{ width: `${progress}%` }}
                                    ></div>

                                    <div className="p-4 flex flex-col h-full">
                                        <div className="flex justify-between items-start mb-4">
                                            <div className="flex items-center gap-3">
                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg shadow-inner ${isLeader ? `bg-gradient-to-br ${theme.trophy || 'from-yellow-400 to-orange-500'} text-white` : `${theme.button} text-current`}`}>
                                                    {isLeader ? <Icon name="Trophy" size={18} /> : player.name.charAt(0)}
                                                </div>
                                                <div>
                                                    <h3 className={`font-bold text-lg leading-tight flex items-center gap-2 ${theme.text}`}>
                                                        {player.name}
                                                        {isWaiting && <Icon name="Check" size={14} className="text-emerald-400" />}
                                                    </h3>
                                                    <div className="flex items-center gap-2 mt-1">
                                                        <span className={`text-xs ${theme.textMuted}`}>Letzte:</span>
                                                        <span className={`text-xs font-mono font-bold px-1.5 py-0.5 rounded ${lastRoundPoints === 0 ? 'bg-red-500/20 text-red-400' : lastRoundPoints > 0 ? 'bg-emerald-500/20 text-emerald-400' : theme.textMuted}`}>
                                                            {lastRoundPoints !== null ? (lastRoundPoints === 0 ? 'BUST' : `+${lastRoundPoints}`) : '-'}
                                                        </span>
                                                        {lastEntry?.freeze && <Icon name="Snowflake" size={12} className="text-cyan-400" />}
                                                        {lastEntry?.secondChance && <Icon name="Heart" size={12} className="text-pink-400" />}
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <div className={`text-3xl font-mono font-bold tracking-tighter ${theme.text}`}>
                                                    {player.score}
                                                </div>
                                                <div className={`text-xs font-medium text-right ${theme.textMuted}`}>Punkte</div>
                                            </div>
                                        </div>

                                        <div className="mt-auto grid grid-cols-4 gap-2">
                                            <button 
                                                onClick={() => setViewHistoryPlayer(player)}
                                                className={`col-span-1 rounded-lg py-3 flex items-center justify-center transition-colors ${theme.button}`}
                                            >
                                                <Icon name="History" size={18} />
                                            </button>
                                            <button 
                                                onClick={() => setSelectedPlayer(player)}
                                                disabled={isWaiting}
                                                className={`col-span-3 font-bold py-3 rounded-lg shadow-lg flex items-center justify-center gap-2 transition-all active:scale-95
                                                    ${isWaiting 
                                                        ? `${theme.button} opacity-50 cursor-not-allowed shadow-none` 
                                                        : theme.buttonPrimary}
                                                `}
                                            >
                                                {isWaiting ? <Icon name="Check" size={18} /> : <><Icon name="Plus" size={18} /> Punkte</>}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    {selectedPlayer && (
                        <ScoreInput 
                            player={selectedPlayer} 
                            onClose={() => setSelectedPlayer(null)} 
                            onSave={handleScoreSave}
                        />
                    )}

                    {viewHistoryPlayer && (
                        <div className={`fixed inset-0 z-50 flex items-center justify-center ${theme.modalOverlay} backdrop-blur-sm p-4 font-inter`}>
                            <div className={`w-full max-w-sm ${theme.panel} rounded-2xl overflow-hidden shadow-2xl max-h-[80vh] flex flex-col`}>
                                <div className={`p-4 flex justify-between items-center border-b ${theme.colors?.input ? theme.colors.input.split(' ')[1] : 'border-white/10'}`}>
                                    <h3 className={`font-bold text-lg ${theme.text}`}>Verlauf: {viewHistoryPlayer.name}</h3>
                                    <button onClick={() => setViewHistoryPlayer(null)} className={`p-2 rounded-full hover:opacity-70 ${theme.textMuted}`}>
                                        <Icon name="X" size={20} />
                                    </button>
                                </div>
                                <div className="p-4 overflow-y-auto flex-1">
                                     <table className="w-full text-left border-collapse">
                                        <thead>
                                            <tr className={`text-sm border-b ${theme.colors?.input ? theme.colors.input.split(' ')[1] : 'border-white/10'} ${theme.textMuted}`}>
                                                <th className="py-2 px-2">#</th>
                                                <th className="py-2 px-2 text-right">Punkte</th>
                                                <th className="py-2 px-2 text-center">Infos</th>
                                                <th className="py-2 px-2 text-right">Σ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {viewHistoryPlayer.history.map((entry, idx) => (
                                                <tr key={idx} className={`border-b ${theme.colors?.input ? theme.colors.input.split(' ')[1] : 'border-white/10'} last:border-0`}>
                                                    <td className={`py-3 px-2 ${theme.textMuted}`}>{idx + 1}</td>
                                                    <td className={`py-3 px-2 text-right font-mono ${entry.points === 0 ? 'text-red-400' : 'text-emerald-400'}`}>
                                                        {entry.points > 0 ? '+' : ''}{entry.points}
                                                    </td>
                                                    <td className="py-3 px-2 text-center flex justify-center gap-1">
                                                        {entry.freeze && <Icon name="Snowflake" size={14} className="text-cyan-400" />}
                                                        {entry.secondChance && <Icon name="Heart" size={14} className="text-pink-400" />}
                                                    </td>
                                                    <td className={`py-3 px-2 text-right font-bold ${theme.text}`}>
                                                        {entry.totalAfter}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    )}

                    {showSettings && (
                        <SettingsModal 
                            onClose={() => setShowSettings(false)}
                            onQuit={onEndGame}
                            currentThemeId={currentThemeId}
                            onSetTheme={setThemeId}
                        />
                    )}
                </div>
            );
        };

        const App = () => {
            const [appState, setAppState] = useState('setup');
            const [players, setPlayers] = useState([]);
            const [targetScore, setTargetScore] = useState(501);
            const [winner, setWinner] = useState(null);
            const [currentThemeId, setCurrentThemeId] = useState('midnight');

            // Set body background based on theme to prevent white flashes
            useEffect(() => {
                const colors = themes[currentThemeId].colors;
                // Extrahiere nur die bg-farbe klasse wenn möglich, ansonsten fallback auf style
                document.body.className = `${colors.bg} ${colors.text} transition-colors duration-500`;
            }, [currentThemeId]);

            const startGame = (playerNames, target) => {
                const initialPlayers = playerNames.map((name, idx) => ({
                    id: idx,
                    name: name,
                    score: 0,
                    history: []
                }));
                setPlayers(initialPlayers);
                setTargetScore(target);
                setAppState('playing');
            };

            const updateScore = (playerId, points, specials = { freeze: false, secondChance: false }) => {
                const updatedPlayers = players.map(p => {
                    if (p.id === playerId) {
                        const newScore = p.score + points;
                        const newHistory = [...p.history, { 
                            points, 
                            totalAfter: newScore,
                            freeze: specials.freeze,
                            secondChance: specials.secondChance
                        }];
                        return { ...p, score: newScore, history: newHistory };
                    }
                    return p;
                });
                setPlayers(updatedPlayers);

                const player = updatedPlayers.find(p => p.id === playerId);
                if (player.score >= targetScore) {
                    setWinner(player);
                    setAppState('finished');
                }
            };

            const resetGame = () => {
                setAppState('setup');
                setWinner(null);
                setPlayers([]);
            };

            return (
                <ThemeContext.Provider value={{ 
                    theme: themes[currentThemeId].colors, 
                    currentThemeId, 
                    setThemeId: setCurrentThemeId 
                }}>
                    {appState === 'setup' && <SetupScreen onStart={startGame} />}
                    {appState === 'playing' && (
                        <GameScreen 
                            players={players} 
                            targetScore={targetScore} 
                            onUpdateScore={updateScore}
                            onEndGame={resetGame}
                        />
                    )}
                    {appState === 'finished' && (
                        <WinnerScreen winner={winner} players={players} onReset={resetGame} />
                    )}
                </ThemeContext.Provider>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
